<!-- shop/templates/search.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты поиска</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="main-block" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="search-top">
            <a href="/" class="s-btn" aria-label="Назад">‹</a>
            <input id="searchInput" type="text" placeholder="Поиск в каталоге" value="{{ query }}" autofocus>
            <button id="clearBtn" class="s-btn" aria-label="Очистить">×</button>
        </div>

        <div class="search-summary" id="summary">Введите запрос…</div>
        <ul class="search-results-list" id="results"></ul>
        <a href="/" class="search-back">← На главную</a>
    </div>

    <style>
        .search-top {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin: 8px;
            background: #fff;
            border: 1px solid #eaeaea;
            border-radius: 12px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, .06);
        }

        .search-top input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: none;
        }

        .s-btn {
            width: 36px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            background: #fff;
        }

        .result-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .result-row img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 6px;
            background: #f5f5f5;
        }

        .result-name {
            font-weight: 500;
        }

        .result-price {
            color: #111;
            font-weight: 700;
        }
    </style>

    <script>
        const inputEl = document.getElementById('searchInput');
        const resultsEl = document.getElementById('results');
        const summaryEl = document.getElementById('summary');
        const clearBtn = document.getElementById('clearBtn');

        function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), ms); }; }

        async function doSearch(q) {
            const url = '/api/search?q=' + encodeURIComponent(q || '');
            const res = await fetch(url);
            const data = await res.json();
            summaryEl.textContent = data.query ? `Запрос: ${data.query} — найдено: ${data.count}` : 'Введите запрос…';
            renderResults(data.results || []);
        }

        function renderResults(items) {
            resultsEl.innerHTML = items.map(r => {
                const img = r.image || '/static/pic/cat/no-image.jpg';
                const name = `${r.art || ''} ${r.name || ''}`.trim();
                return `<li><a class="result-row" href="${r.url}"><img src="${img}" alt="${name}" onerror="this.src='/static/pic/cat/no-image.jpg'"/><div><div class="result-name">${name}</div>${r.category ? `<div class=\"result-cat\">${r.category}</div>` : ''}</div></a></li>`;
            }).join('');
        }

        const debounced = debounce(doSearch, 250);
        inputEl.addEventListener('input', (e) => debounced(e.target.value));
        clearBtn.addEventListener('click', () => { inputEl.value = ''; inputEl.focus(); debounced(''); });

        // Первичная загрузка (если пришли с q в URL)
        if (inputEl.value) doSearch(inputEl.value);
    </script>
</body>

</html>