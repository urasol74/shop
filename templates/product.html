<!--
  Benetton Mini App
  Универсальная страница отдельного товара для всех категорий
-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} — Benetton {{ section_verbose }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Стили для сердечка избранного */
        .favorite-heart-block {
            margin: 12px;
            padding: 16px;
            background: #fff;
            border-radius: 16px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 6px rgba(0, 0, 0, .08);
        }
        
        .favorite-heart-btn {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e6e6e6;
            border-radius: 12px;
            background: #fff;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .favorite-heart-btn:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
            background: #fff;
        }
        
        .favorite-heart-btn.active {
            border-color: #ff6b6b;
            background: #ff6b6b;
            color: #fff;
        }
        
        .favorite-heart-icon {
            font-size: 20px;
        }
        
        .favorite-heart-text {
            font-weight: 500;
        }
        .product-prices-list .sale {
            font-size: 14px;
            color: #f28c28;
            font-weight: 600;
        }
        
        /* Стили для сердечка избранного */
    </style>
</head>

<body>
    <div class="main-block">
        <!-- Кнопка назад -->
        <a href="{{ back_url }}" class="back-btn">← Назад</a>
        <!-- Слайдер картинок товара -->
        <div class="slider-container">
            <button class="slider-arrow left" type="button">&#8592;</button>
            <div class="product-slider" id="product-slider">
                {% for img in product_images %}
                <img src="/static/pic/list/{{ img }}" alt="{{ product.name }}"
                    onerror="this.onerror=null; this.src='/static/pic/list/no-image.jpg';">
                {% endfor %}
            </div>
            <button class="slider-arrow right" type="button">&#8594;</button>
        </div>
        <!-- Модальное окно для просмотра оригинала -->
        <div id="modal-viewer" class="modal-viewer">
            <span class="modal-close" id="modal-close">&times;</span>
            <button class="modal-arrow left" type="button">&#8592;</button>
            <img id="modal-img" src="" alt="Фото товара">
            <button class="modal-arrow right" type="button">&#8594;</button>
        </div>
        <!-- Название, цены, описание и т.д. -->
        <div class="product-block name-block">
            <div class="product-name-list">{{ product.name or product.art }}</div>
        </div>
        <div class="product-block price-block">
            <div class="product-prices-list" id="priceBox">
                {% if product.sale %}
                <span class="old-price-list" id="pOld">{% if product.old_price %}{{ product.old_price|format_price }}
                    грн.{% endif %}</span>
                <span class="new-price-list" id="pNew">{% if product.new_price %}{{ product.new_price|format_price }}
                    грн.{% endif %}</span>
                <span class="big-sale" id="pSale">-{% if product.sale %}{{ product.sale|format_sale }}{% endif
                    %}%</span>
                {% else %}
                <span class="old-price-list" id="pOld"></span>
                <span class="new-price-list" id="pNew">{% if product.old_price %}{{ product.old_price|format_price }}
                    грн.{% endif %}</span>
                <span class="big-sale" id="pSale" style="display:none;"></span>
                {% endif %}
            </div>
        </div>
        
        <div class="meta-block">
            {% if color_size_map %}
            <div id="matrix">
                <table class="color-size-table">
                    <thead>
                        <tr>
                            <th style="width:35%;">Цвет</th>
                            <th>Размер</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cs in color_size_map %}
                        <tr>
                            <td class="c-cell">{{ cs.color }}</td>
                            <td class="s-cell">
                                {% for sz in cs.sizes %}
                                <button class="gender-btn size-chip" data-color="{{ cs.color }}" data-size="{{ sz }}">{{
                                    sz }}</button>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
        
        <!-- Сердечко для добавления в избранное -->
        <div class="product-block favorite-heart-block">
            <button id="favoriteBtn" class="favorite-heart-btn" data-product-id="{{ product.id }}" data-product-name="{{ product.name or product.art }}" data-product-art="{{ product.art }}" data-product-url="{{ request.path }}">
                <span class="favorite-heart-icon">♡</span>
                <span class="favorite-heart-text">К избранному</span>
            </button>
        </div>
        
        <!-- ...другие блоки... -->
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Слайдер (как раньше)
            const slider = document.getElementById('product-slider');
            const images = slider.querySelectorAll('img');
            const leftBtn = document.querySelector('.slider-arrow.left');
            const rightBtn = document.querySelector('.slider-arrow.right');
            let current = 0;
            function showImage(idx) {
                images.forEach((img, i) => {
                    img.style.display = (i === idx) ? 'block' : 'none';
                });
            }
            showImage(current);
            leftBtn.addEventListener('click', () => {
                current = (current - 1 + images.length) % images.length;
                showImage(current);
            });
            rightBtn.addEventListener('click', () => {
                current = (current + 1) % images.length;
                showImage(current);
            });
            // Свайп для мобильных
            let startX = null;
            slider.addEventListener('touchstart', function (e) {
                startX = e.touches[0].clientX;
            });
            slider.addEventListener('touchend', function (e) {
                if (startX === null) return;
                let endX = e.changedTouches[0].clientX;
                if (endX - startX > 40) {
                    current = (current - 1 + images.length) % images.length;
                    showImage(current);
                } else if (startX - endX > 40) {
                    current = (current + 1) % images.length;
                    showImage(current);
                }
                startX = null;
            });

            // Модальное окно (лайтбокс)
            const modal = document.getElementById('modal-viewer');
            const modalImg = document.getElementById('modal-img');
            const modalClose = document.getElementById('modal-close');
            const modalLeft = document.querySelector('.modal-viewer .modal-arrow.left');
            const modalRight = document.querySelector('.modal-viewer .modal-arrow.right');
            let modalCurrent = 0;
            // Пути к оригинальным картинкам
            const origImages = Array.from(images).map(img => {
                const src = img.getAttribute('src');
                const filename = src.split('/').pop();
                return '/static/pic/' + filename;
            });
            // Открытие модального окна
            images.forEach((img, idx) => {
                img.addEventListener('click', function () {
                    modalCurrent = idx;
                    modalImg.src = origImages[modalCurrent];
                    modal.style.display = 'flex';
                });
            });
            function showModalImg(idx) {
                modalImg.src = origImages[idx];
            }
            modalLeft.addEventListener('click', function () {
                modalCurrent = (modalCurrent - 1 + origImages.length) % origImages.length;
                showModalImg(modalCurrent);
            });
            modalRight.addEventListener('click', function () {
                modalCurrent = (modalCurrent + 1) % origImages.length;
                showModalImg(modalCurrent);
            });
            modalClose.addEventListener('click', function () {
                modal.style.display = 'none';
            });
            // Клик вне картинки — закрыть
            modal.addEventListener('click', function (e) {
                if (e.target === modal) modal.style.display = 'none';
            });
            // Свайп для мобильных в модалке
            let modalStartX = null;
            modalImg.addEventListener('touchstart', function (e) {
                modalStartX = e.touches[0].clientX;
            });
            modalImg.addEventListener('touchend', function (e) {
                if (modalStartX === null) return;
                let endX = e.changedTouches[0].clientX;
                if (endX - modalStartX > 40) {
                    modalCurrent = (current - 1 + origImages.length) % origImages.length;
                    showModalImg(modalCurrent);
                } else if (modalStartX - endX > 40) {
                    modalCurrent = (current + 1) % origImages.length;
                    showModalImg(modalCurrent);
                }
                modalStartX = null;
            });
            
            // Функциональность кнопки избранного
            const favoriteBtn = document.getElementById('favoriteBtn');
            const favoriteIcon = favoriteBtn.querySelector('.favorite-heart-icon');
            const favoriteText = favoriteBtn.querySelector('.favorite-heart-text');
            
            // Проверяем, есть ли товар в избранном
            function checkFavoriteStatus() {
                const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                const productId = favoriteBtn.dataset.productId;
                const productArt = favoriteBtn.dataset.productArt;
                
                const isFavorite = favorites.some(item => 
                    item.id == productId && item.art === productArt
                );
                
                if (isFavorite) {
                    favoriteBtn.classList.add('active');
                    favoriteIcon.textContent = '♥';
                    favoriteText.textContent = 'В избранном';
                } else {
                    favoriteBtn.classList.remove('active');
                    favoriteIcon.textContent = '♡';
                    favoriteText.textContent = 'К избранному';
                }
            }
            
            // Добавление/удаление из избранного
            favoriteBtn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                const productName = this.dataset.productName;
                const productArt = this.dataset.productArt;
                const productUrl = this.dataset.productUrl;
                
                let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                
                const existingIndex = favorites.findIndex(item => 
                    item.id == productId && item.art === productArt
                );
                
                if (existingIndex !== -1) {
                    // Удаляем из избранного
                    favorites.splice(existingIndex, 1);
                    favoriteBtn.classList.remove('active');
                    favoriteIcon.textContent = '♡';
                    favoriteText.textContent = 'К избранному';
                } else {
                    // Добавляем в избранное
                    const productData = {
                        id: productId,
                        name: productName,
                        art: productArt,
                        url: productUrl,
                        image: null // Можно добавить изображение позже
                    };
                    favorites.push(productData);
                    favoriteBtn.classList.add('active');
                    favoriteIcon.textContent = '♥';
                    favoriteText.textContent = 'В избранном';
                }
                
                localStorage.setItem('favorites', JSON.stringify(favorites));
            });
            
            // Проверяем статус при загрузке страницы
            checkFavoriteStatus();
            
            // Сезоны, цвета и размеры отрендерены сервером (таблица). Ничего не делаем в JS.
        });
    </script>
</body>

</html>